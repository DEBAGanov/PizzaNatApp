# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –æ—à–∏–±–∫–∏ —á–µ–∫–∞ –Æ–ö–∞—Å—Å—ã

**–î–∞—Ç–∞**: 30.01.2025  
**–°—Ç–∞—Ç—É—Å**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è backend  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –í–´–°–û–ö–ò–ô  

## üö® –ü—Ä–æ–±–ª–µ–º–∞

–Æ–ö–∞—Å—Å–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –°–ë–ü –ø–ª–∞—Ç–µ–∂–µ–π:

```json
{
  "type": "error",
  "id": "01983884-4262-7bcf-ae30-5cbfdbebea29",
  "code": "invalid_request",
  "description": "Invalid parameter's value (for example, the value is illegal or its format is incorrect). Send the value in accordance with the documentation.",
  "parameter": "receipt.items.amount"
}
```

**–ü—Ä–∏—á–∏–Ω–∞**: –°—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —á–µ–∫–µ –Ω–µ —Ä–∞–≤–Ω–∞ –æ–±—â–µ–π —Å—É–º–º–µ –ø–ª–∞—Ç–µ–∂–∞:
- **–û–±—â–∞—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞**: 201.0 ‚ÇΩ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- **–°—É–º–º–∞ —Ç–æ–≤–∞—Ä–∞ –≤ —á–µ–∫–µ**: 1.00 ‚ÇΩ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

## üîç –ê–Ω–∞–ª–∏–∑

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. ‚ùå **–î–≤–æ–π–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏**: –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ—Ç 200‚ÇΩ –¥–æ—Å—Ç–∞–≤–∫–∏ –∫ —Å—É–º–º–µ —Ç–æ–≤–∞—Ä–æ–≤
2. ‚ùå **Backend —Ç–æ–∂–µ –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–æ—Å—Ç–∞–≤–∫—É**: –ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —á–µ–∫–∞ –Æ–ö–∞—Å—Å—ã backend –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–≤–æ—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏  
3. ‚ùå **–¢–æ–≤–∞—Ä—ã –∏–º–µ—é—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ —Ü–µ–Ω—ã**: –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä—ã —Å—Ç–æ—è—Ç 1‚ÇΩ –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω
4. ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û –≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏**: –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤ (subtotal), backend —Å–∞–º –¥–æ–±–∞–≤–∏—Ç –¥–æ—Å—Ç–∞–≤–∫—É

### –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –∫ –Æ–ö–∞—Å—Å–µ:
```json
{
  "amount": {
    "currency": "RUB",
    "value": "201.0"  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—â–∞—è —Å—É–º–º–∞
  },
  "receipt": {
    "items": [
      {
        "description": "–ú—è—Å–Ω–∞—è –ø–∏—Ü—Ü–∞",
        "quantity": "1.00",
        "amount": {
          "value": "1.00",  // ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ü–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞
          "currency": "RUB"
        },
        "vat_code": 1
      }
    ]
  }
}
```

## üõ†Ô∏è –†–µ—à–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ü–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

```sql
-- –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
UPDATE products SET price = 559.00 WHERE name = '–ú—è—Å–Ω–∞—è –ø–∏—Ü—Ü–∞';
UPDATE products SET price = 449.00 WHERE name = '–ú–∞—Ä–≥–∞—Ä–∏—Ç–∞';
-- –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ–∫–∞

–ò–∑–º–µ–Ω–∏—Ç—å backend –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —á–µ–∫ –¥–ª—è –Æ–ö–∞—Å—Å—ã:

```java
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ Spring Boot –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
@PostMapping("/payments/yookassa/create")
public ResponseEntity<PaymentDto> createPayment(@RequestBody CreatePaymentRequest request) {
    Order order = orderService.findById(request.getOrderId());
    
    // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤ –≤ —á–µ–∫–µ
    List<ReceiptItem> receiptItems = new ArrayList<>();
    
    // –ï—Å–ª–∏ —Å—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑–µ –Ω–µ —Ä–∞–≤–Ω–∞ –æ–±—â–µ–π —Å—É–º–º–µ –ø–ª–∞—Ç–µ–∂–∞
    double orderItemsSum = order.getItems().stream()
        .mapToDouble(item -> item.getPrice() * item.getQuantity())
        .sum();
    
    double expectedSum = request.getAmount() - order.getDeliveryCost();
    
    if (Math.abs(orderItemsSum - expectedSum) > 0.01) {
        // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤
        double correctionFactor = expectedSum / orderItemsSum;
        
        for (OrderItem item : order.getItems()) {
            double correctedPrice = item.getPrice() * correctionFactor;
            receiptItems.add(new ReceiptItem(
                item.getName(),
                correctedPrice,
                item.getQuantity()
            ));
        }
    } else {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ —Ü–µ–Ω—ã
        for (OrderItem item : order.getItems()) {
            receiptItems.add(new ReceiptItem(
                item.getName(),
                item.getPrice(),
                item.getQuantity()
            ));
        }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ—Å—Ç–∞–≤–∫—É –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (order.getDeliveryCost() > 0) {
        receiptItems.add(new ReceiptItem(
            "–î–æ—Å—Ç–∞–≤–∫–∞",
            order.getDeliveryCost(),
            1
        ));
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –Æ–ö–∞—Å—Å—É
    return yookassaService.createPayment(request.getAmount(), receiptItems);
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ —á–µ–∫–∏ –±–µ–∑ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ (–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

```java
// –£–±—Ä–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π —á–µ–∫ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–±—â—É—é —Å—É–º–º—É
// –ù–ï –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢ 54-–§–ó –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤
PaymentRequest paymentRequest = PaymentRequest.builder()
    .amount(Amount.builder()
        .value(request.getAmount())
        .currency("RUB")
        .build())
    .description(request.getDescription())
    // –£–±–∏—Ä–∞–µ–º receipt –ø–æ–ª–Ω–æ—Å—Ç—å—é
    .build();
```

## üÜï –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### ‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞:

1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–≤–æ–π–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏**: 
   ```kotlin
   // –ë–´–õ–û:
   createSbpPayment(orderId, _uiState.value.total, ...)  // —Ç–æ–≤–∞—Ä—ã + –¥–æ—Å—Ç–∞–≤–∫–∞
   
   // –°–¢–ê–õ–û:
   createSbpPayment(orderId, _uiState.value.subtotal, ...)  // —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã
   ```

2. **–õ–æ–≥–∏–∫–∞**: Backend —Ç–µ–ø–µ—Ä—å —Å–∞–º –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–æ—Å—Ç–∞–≤–∫—É –≤ —á–µ–∫ –Æ–ö–∞—Å—Å—ã, –∏–∑–±–µ–≥–∞—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

### üõ°Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞:

1. **Graceful Fallback**: –ü—Ä–∏ –æ—à–∏–±–∫–µ —á–µ–∫–∞ –Æ–ö–∞—Å—Å—ã –∑–∞–∫–∞–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –∫–∞–∫ "–ö–∞—Ä—Ç–æ–π/–Ω–∞–ª–∏—á–Ω—ã–º–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏"

2. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**: –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º:
   ```kotlin
   Log.d("PaymentViewModel", "üõí –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –¢–û–í–ê–†–û–í –î–õ–Ø –Æ–ö–ê–°–°–´:")
   Log.d("PaymentViewModel", "  üì¶ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑–µ: ${data.cartItems.size}")
   Log.d("PaymentViewModel", "  üîß –í–ê–ñ–ù–û: –ü–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—É–º–º—É —Ç–æ–≤–∞—Ä–æ–≤, backend –¥–æ–±–∞–≤–∏—Ç –¥–æ—Å—Ç–∞–≤–∫—É –≤ —á–µ–∫")
   ```

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏**: –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ `receipt.items.amount` –æ—à–∏–±–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è fallback

## üìã –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –î–ª—è Backend –∫–æ–º–∞–Ω–¥—ã:

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ**: –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
2. **–°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É —Ü–µ–Ω –≤ —á–µ–∫–µ (–í–∞—Ä–∏–∞–Ω—Ç 2)
3. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ**: –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ü–µ–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–æ–≤

### –î–ª—è Mobile –∫–æ–º–∞–Ω–¥—ã:

1. ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–æ**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–≤–æ–π–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏ - –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤
2. ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–æ**: –î–æ–±–∞–≤–ª–µ–Ω graceful fallback –¥–ª—è –æ—à–∏–±–æ–∫ —á–µ–∫–∞
3. ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–æ**: –†–∞—Å—à–∏—Ä–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
4. **–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é**: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω —Ç–æ–≤–∞—Ä–æ–≤ –≤ backend

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è backend –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

1. **–°–æ–∑–¥–∞–Ω–∏–µ –°–ë–ü –ø–ª–∞—Ç–µ–∂–∞** - –¥–æ–ª–∂–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫
2. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–∫–∞** - —Å—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤ –¥–æ–ª–∂–Ω–∞ —Ä–∞–≤–Ω—è—Ç—å—Å—è –æ–±—â–µ–π —Å—É–º–º–µ
3. **–†–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏**:
   - –ó–∞–∫–∞–∑ —Å –æ–¥–Ω–∏–º —Ç–æ–≤–∞—Ä–æ–º
   - –ó–∞–∫–∞–∑ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏
   - –ó–∞–∫–∞–∑ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π
   - –ó–∞–∫–∞–∑ –±–µ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏ (—Å–∞–º–æ–≤—ã–≤–æ–∑)

## üì± –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –∫–æ–º–∞–Ω–¥–µ –º–æ–±–∏–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

---

**–û–±–Ω–æ–≤–ª–µ–Ω–æ**: 30.01.2025 (18:00) - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–≤–æ–π–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏ 