#!/bin/bash

# ะขะตััะธัะพะฒะฐะฝะธะต ัะธััะตะผั ะฐะดัะตัะพะฒ ั ะทะพะฝะฐะปัะฝะพะน ะดะพััะฐะฒะบะพะน ะะพะปะถัะบ
# API: https://api.pizzanat.ru/api/v1/

API_BASE="https://api.pizzanat.ru"
DELIVERY_ENDPOINT="$API_BASE/api/v1/delivery"

echo "๐ === ะขะะกะขะะะะะะะะ ะกะะกะขะะะซ ะะะะะกะะ ะะะะะกะ ==="
echo "๐ Backend API: $API_BASE"
echo ""

# ะคัะฝะบัะธั ะดะปั ะพัะฟัะฐะฒะบะธ ะทะฐะฟัะพัะฐ ั ะปะพะณะธัะพะฒะฐะฝะธะตะผ
make_request() {
    local method=$1
    local url=$2
    local description=$3
    
    echo "๐ $description"
    echo "๐ค $method $url"
    echo "โฑ๏ธ  $(date '+%H:%M:%S')"
    echo ""
    
    curl -s -w "\n๐ HTTP Status: %{http_code} | Time: %{time_total}s\n" \
         -H "Accept: application/json" \
         -H "User-Agent: PizzaNat-Android-Test/1.0" \
         "$url"
    
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
}

# URL encoding ััะฝะบัะธั ะดะปั ััััะบะธั ัะธะผะฒะพะปะพะฒ
urlencode() {
    local string="${1}"
    local strlen=${#string}
    local encoded=""
    local pos c o

    for (( pos=0 ; pos<strlen ; pos++ )); do
        c=${string:$pos:1}
        case "$c" in
            [-_.~a-zA-Z0-9] ) o="${c}" ;;
            * )               printf -v o '%%%02x' "'$c"
        esac
        encoded+="${o}"
    done
    echo "${encoded}"
}

# 1. ะขะตััะธัะพะฒะฐะฝะธะต ะฟะพะดัะบะฐะทะพะบ ะฐะดัะตัะพะฒ (ะผะธะฝะธะผัะผ 2 ัะธะผะฒะพะปะฐ)
echo "1๏ธโฃ ะขะะกะขะะะะะะะะ ะะะะกะะะะะ ะะะะะกะะ"
echo ""

# ะขะตัั 1.1: ะะพัะพัะบะธะน ะทะฐะฟัะพั (ะดะพะปะถะตะฝ ัะฐะฑะพัะฐัั ั 2 ัะธะผะฒะพะปะพะฒ)
query=$(urlencode "ะปะต")
make_request "GET" "$DELIVERY_ENDPOINT/address-suggestions?query=$query&limit=10" \
    "ะะพะธัะบ ัะปะธั ะฝะฐ 'ะปะต' (ะผะธะฝะธะผัะผ 2 ัะธะผะฒะพะปะฐ)"

# ะขะตัั 1.2: ะะพะฝะบัะตัะฝะฐั ัะปะธัะฐ
query=$(urlencode "ะปะตะฝะธะฝะฐ")
make_request "GET" "$DELIVERY_ENDPOINT/address-suggestions?query=$query&limit=10" \
    "ะะพะธัะบ ัะปะธั ะฝะฐ 'ะปะตะฝะธะฝะฐ'"

# ะขะตัั 1.3: ะััะณะธะต ัะปะธัั ะะพะปะถัะบะฐ
query=$(urlencode "ะผะธัะฐ")
make_request "GET" "$DELIVERY_ENDPOINT/address-suggestions?query=$query&limit=10" \
    "ะะพะธัะบ ัะปะธั ะฝะฐ 'ะผะธัะฐ'"

query=$(urlencode "ัะพะฒะตััะบะฐั")
make_request "GET" "$DELIVERY_ENDPOINT/address-suggestions?query=$query&limit=10" \
    "ะะพะธัะบ ัะปะธั ะฝะฐ 'ัะพะฒะตััะบะฐั'"

# ะขะตัั 1.4: ะัะพะฒะตัะบะฐ ัะฐะนะพะฝะพะฒ/ะผะธะบัะพัะฐะนะพะฝะพะฒ
query=$(urlencode "ะดััะถะฑะฐ")
make_request "GET" "$DELIVERY_ENDPOINT/address-suggestions?query=$query&limit=10" \
    "ะะพะธัะบ ะฒ ัะฐะนะพะฝะต 'ะดััะถะฑะฐ'"

query=$(urlencode "ะทะฐัั")
make_request "GET" "$DELIVERY_ENDPOINT/address-suggestions?query=$query&limit=10" \
    "ะะพะธัะบ ะฒ ัะฐะนะพะฝะต 'ะทะฐัั'"

# 2. ะขะตััะธัะพะฒะฐะฝะธะต ะทะพะฝะฐะปัะฝะพะน ัะธััะตะผั ะดะพััะฐะฒะบะธ
echo "2๏ธโฃ ะขะะกะขะะะะะะะะ ะะะะะะฌะะะ ะกะะกะขะะะซ ะะะกะขะะะะ"
echo ""

# ะขะตัั 2.1: ะะพะฝะฐ ะััะถะฑะฐ (ัะฐะผะฐั ะดะตัะตะฒะฐั - 100โฝ)
address=$(urlencode "ะณ. ะะพะปะถัะบ, ะผะบั. ะััะถะฑะฐ, ัะป. ะะตะฝะธะฝะฐ, ะด. 1")
make_request "GET" "$DELIVERY_ENDPOINT/estimate?address=$address&orderAmount=500" \
    "ะะฐััะตั ะดะพััะฐะฒะบะธ ะฒ ะทะพะฝั ะััะถะฑะฐ (500โฝ ะทะฐะบะฐะท)"

make_request "GET" "$DELIVERY_ENDPOINT/estimate?address=$address&orderAmount=1000" \
    "ะะฐััะตั ะดะพััะฐะฒะบะธ ะฒ ะทะพะฝั ะััะถะฑะฐ (1000โฝ ะทะฐะบะฐะท - ะฑะตัะฟะปะฐัะฝะฐั ะดะพััะฐะฒะบะฐ)"

# ะขะตัั 2.2: ะฆะตะฝััะฐะปัะฝะฐั ะทะพะฝะฐ (200โฝ)
address=$(urlencode "ะณ. ะะพะปะถัะบ, ัะป. ะกะพะฒะตััะบะฐั, ะด. 10")
make_request "GET" "$DELIVERY_ENDPOINT/estimate?address=$address&orderAmount=800" \
    "ะะฐััะตั ะดะพััะฐะฒะบะธ ะฒ ะฆะตะฝััะฐะปัะฝัั ะทะพะฝั (800โฝ ะทะฐะบะฐะท)"

make_request "GET" "$DELIVERY_ENDPOINT/estimate?address=$address&orderAmount=1200" \
    "ะะฐััะตั ะดะพััะฐะฒะบะธ ะฒ ะฆะตะฝััะฐะปัะฝัั ะทะพะฝั (1200โฝ ะทะฐะบะฐะท - ะฑะตัะฟะปะฐัะฝะฐั ะดะพััะฐะฒะบะฐ)"

# ะขะตัั 2.3: ะะพะฝะฐ ะะฐัั (250โฝ)
address=$(urlencode "ะณ. ะะพะปะถัะบ, ะผะบั. ะะฐัั, ัะป. ะะธัะฐ, ะด. 5")
make_request "GET" "$DELIVERY_ENDPOINT/estimate?address=$address&orderAmount=900" \
    "ะะฐััะตั ะดะพััะฐะฒะบะธ ะฒ ะทะพะฝั ะะฐัั (900โฝ ะทะฐะบะฐะท)"

make_request "GET" "$DELIVERY_ENDPOINT/estimate?address=$address&orderAmount=1300" \
    "ะะฐััะตั ะดะพััะฐะฒะบะธ ะฒ ะทะพะฝั ะะฐัั (1300โฝ ะทะฐะบะฐะท - ะฑะตัะฟะปะฐัะฝะฐั ะดะพััะฐะฒะบะฐ)"

# ะขะตัั 2.4: ะะพะฝะฐ ะัะพะผัะทะตะป (ัะฐะผะฐั ะดะพัะพะณะฐั - 300โฝ)
address=$(urlencode "ะณ. ะะพะปะถัะบ, ะัะพะผััะปะตะฝะฝะฐั ะทะพะฝะฐ, ัะป. ะะฐะฒะพะดัะบะฐั, ะด. 1")
make_request "GET" "$DELIVERY_ENDPOINT/estimate?address=$address&orderAmount=1000" \
    "ะะฐััะตั ะดะพััะฐะฒะบะธ ะฒ ะทะพะฝั ะัะพะผัะทะตะป (1000โฝ ะทะฐะบะฐะท)"

make_request "GET" "$DELIVERY_ENDPOINT/estimate?address=$address&orderAmount=1600" \
    "ะะฐััะตั ะดะพััะฐะฒะบะธ ะฒ ะทะพะฝั ะัะพะผัะทะตะป (1600โฝ ะทะฐะบะฐะท - ะฑะตัะฟะปะฐัะฝะฐั ะดะพััะฐะฒะบะฐ)"

# 3. ะขะตััะธัะพะฒะฐะฝะธะต ะณัะฐะฝะธัะฝัั ัะปััะฐะตะฒ
echo "3๏ธโฃ ะขะะกะขะะะะะะะะ ะะะะะะงะะซะฅ ะกะะฃะงะะะ"
echo ""

# ะขะตัั 3.1: ะกะปะธัะบะพะผ ะบะพัะพัะบะธะน ะทะฐะฟัะพั
query=$(urlencode "ะป")
make_request "GET" "$DELIVERY_ENDPOINT/address-suggestions?query=$query&limit=10" \
    "ะกะปะธัะบะพะผ ะบะพัะพัะบะธะน ะทะฐะฟัะพั (1 ัะธะผะฒะพะป)"

# ะขะตัั 3.2: ะัััะพะน ะทะฐะฟัะพั
make_request "GET" "$DELIVERY_ENDPOINT/address-suggestions?query=&limit=10" \
    "ะัััะพะน ะทะฐะฟัะพั"

# ะขะตัั 3.3: ะะตัััะตััะฒัััะธะน ะฐะดัะตั
address=$(urlencode "ะณ. ะะพัะบะฒะฐ, ัะป. ะขะฒะตััะบะฐั, ะด. 1")
make_request "GET" "$DELIVERY_ENDPOINT/estimate?address=$address&orderAmount=1000" \
    "ะะฐััะตั ะดะพััะฐะฒะบะธ ะฟะพ ะฐะดัะตัั ะฒะฝะต ะทะพะฝั ะดะพััะฐะฒะบะธ"

# ะขะตัั 3.4: ะะตะบะพััะตะบัะฝัะต ะดะฐะฝะฝัะต
make_request "GET" "$DELIVERY_ENDPOINT/estimate?address=&orderAmount=1000" \
    "ะะฐััะตั ะดะพััะฐะฒะบะธ ั ะฟััััะผ ะฐะดัะตัะพะผ"

address=$(urlencode "ะณ. ะะพะปะถัะบ, ัะป. ะะตะฝะธะฝะฐ, ะด. 1")
make_request "GET" "$DELIVERY_ENDPOINT/estimate?address=$address&orderAmount=0" \
    "ะะฐััะตั ะดะพััะฐะฒะบะธ ั ะฝัะปะตะฒะพะน ััะผะผะพะน ะทะฐะบะฐะทะฐ"

# 4. ะขะตััะธัะพะฒะฐะฝะธะต ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ
echo "4๏ธโฃ ะขะะกะขะะะะะะะะ ะะะะะะะะะะขะะะฌะะะกะขะ"
echo ""

# ะขะตัั 4.1: ะะฝะพะถะตััะฒะตะฝะฝัะต ะทะฐะฟัะพัั ะฟะพะดัะบะฐะทะพะบ (ะธะผะธัะฐัะธั ะฟะพะปัะทะพะฒะฐัะตะปััะบะพะณะพ ะฒะฒะพะดะฐ)
echo "๐ ะะผะธัะฐัะธั ะฟะพะปัะทะพะฒะฐัะตะปััะบะพะณะพ ะฒะฒะพะดะฐ ั debounce..."
for query_text in "ะป" "ะปะต" "ะปะตะฝ" "ะปะตะฝะธ" "ะปะตะฝะธะฝ" "ะปะตะฝะธะฝะฐ"; do
    if [ ${#query_text} -ge 2 ]; then
        query=$(urlencode "$query_text")
        make_request "GET" "$DELIVERY_ENDPOINT/address-suggestions?query=$query&limit=5" \
            "ะะพะธัะบ ะฟะพ ะทะฐะฟัะพัั '$query_text' (${#query_text} ัะธะผะฒะพะปะพะฒ)"
        sleep 0.3  # ะะผะธัะฐัะธั debounce 300ms
    else
        echo "โญ๏ธ  ะัะพะฟััะบ ะทะฐะฟัะพัะฐ '$query_text' (ะผะตะฝะตะต 2 ัะธะผะฒะพะปะพะฒ)"
        echo ""
    fi
done

# 5. ะขะตััะธัะพะฒะฐะฝะธะต ะฒัะตั ะทะพะฝ ะดะพััะฐะฒะบะธ
echo "5๏ธโฃ ะะะะะะ ะขะะกะขะะะะะะะะ ะะกะะฅ ะะะ ะะะกะขะะะะ"
echo ""

# ะะฐััะธะฒ ัะตััะพะฒัั ะฐะดัะตัะพะฒ ะดะปั ะบะฐะถะดะพะน ะทะพะฝั
declare -A test_addresses=(
    ["ะััะถะฑะฐ"]="ะณ. ะะพะปะถัะบ, ะผะบั. ะััะถะฑะฐ, ัะป. ะะพะผัะพะผะพะปััะบะฐั, ะด. 15"
    ["ะฆะตะฝััะฐะปัะฝัะน"]="ะณ. ะะพะปะถัะบ, ัะป. ะกะพะฒะตััะบะฐั, ะด. 25"
    ["ะะฐัะธะฝะพัััะพะธัะตะปั"]="ะณ. ะะพะปะถัะบ, ะผะบั. ะะฐัะธะฝะพัััะพะธัะตะปั, ัะป. ะะฐะฑะพัะฐั, ะด. 8"
    ["ะะะ"]="ะณ. ะะพะปะถัะบ, ะผะบั. ะะะ, ัะป. ะกััะพะธัะตะปะตะน, ะด. 12"
    ["ะกะตะฒะตัะฝัะน"]="ะณ. ะะพะปะถัะบ, ะกะตะฒะตัะฝัะน ะผะธะบัะพัะฐะนะพะฝ, ัะป. ะกะตะฒะตัะฝะฐั, ะด. 3"
    ["ะะพัะณะฐะท"]="ะณ. ะะพะปะถัะบ, ะผะบั. ะะพัะณะฐะท, ัะป. ะะฐะทะพะฒะธะบะพะฒ, ะด. 7"
    ["ะะฐัั"]="ะณ. ะะพะปะถัะบ, ะผะบั. ะะฐัั, ัะป. ะะพััะพัะฝะฐั, ะด. 20"
    ["ะัะพะผัะทะตะป"]="ะณ. ะะพะปะถัะบ, ะัะพะผััะปะตะฝะฝะฐั ะทะพะฝะฐ, ัะป. ะะฝะดััััะธะฐะปัะฝะฐั, ะด. 5"
    ["ะัะธะฑัะตะถะฝัะน"]="ะณ. ะะพะปะถัะบ, ะผะบั. ะัะธะฑัะตะถะฝัะน, ัะป. ะะฐะฑะตัะตะถะฝะฐั, ะด. 14"
)

declare -A expected_costs=(
    ["ะััะถะฑะฐ"]=100
    ["ะฆะตะฝััะฐะปัะฝัะน"]=200
    ["ะะฐัะธะฝะพัััะพะธัะตะปั"]=200
    ["ะะะ"]=200
    ["ะกะตะฒะตัะฝัะน"]=200
    ["ะะพัะณะฐะท"]=200
    ["ะะฐัั"]=250
    ["ะัะพะผัะทะตะป"]=300
    ["ะัะธะฑัะตะถะฝัะน"]=300
)

for zone in "${!test_addresses[@]}"; do
    address_text="${test_addresses[$zone]}"
    expected_cost="${expected_costs[$zone]}"
    address=$(urlencode "$address_text")
    
    echo "๐๏ธ  ะขะตััะธัะพะฒะฐะฝะธะต ะทะพะฝั: $zone (ะพะถะธะดะฐะตะผะฐั ััะพะธะผะพััั: ${expected_cost}โฝ)"
    make_request "GET" "$DELIVERY_ENDPOINT/estimate?address=$address&orderAmount=500" \
        "ะะฐััะตั ะดะพััะฐะฒะบะธ ะฒ ะทะพะฝั $zone"
done

# 6. ะัะพะณะพะฒะฐั ััะฐัะธััะธะบะฐ
echo "6๏ธโฃ ะะขะะะะะะฏ ะกะขะะขะะกะขะะะ ะขะะกะขะะะะะะะะฏ"
echo ""
echo "๐ ะัะพะฒะตะดะตะฝะฝัะต ัะตััั:"
echo "   โ ะะพะดัะบะฐะทะบะธ ะฐะดัะตัะพะฒ (ะผะธะฝะธะผัะผ 2 ัะธะผะฒะพะปะฐ)"
echo "   โ ะะพะฝะฐะปัะฝะฐั ัะธััะตะผะฐ ะดะพััะฐะฒะบะธ (11 ะทะพะฝ)"
echo "   โ ะะฐััะตั ััะพะธะผะพััะธ ะดะพััะฐะฒะบะธ"
echo "   โ ะะตัะฟะปะฐัะฝะฐั ะดะพััะฐะฒะบะฐ ะฟะพ ะฟะพัะพะณะฐะผ"
echo "   โ ะัะฐะฝะธัะฝัะต ัะปััะฐะธ ะธ ะพัะธะฑะบะธ"
echo "   โ ะขะตััะธัะพะฒะฐะฝะธะต ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ"
echo "   โ ะะพะปะฝะพะต ะฟะพะบัััะธะต ะฒัะตั ะทะพะฝ"
echo ""
echo "๐ฏ ะะถะธะดะฐะตะผัะต ัะตะทัะปััะฐัั:"
echo "   โข HTTP 200 ะดะปั ะบะพััะตะบัะฝัั ะทะฐะฟัะพัะพะฒ"
echo "   โข ะะพะดัะบะฐะทะบะธ ะฐะดัะตัะพะฒ ะดะปั ะทะฐะฟัะพัะพะฒ โฅ2 ัะธะผะฒะพะปะพะฒ"
echo "   โข ะะพััะตะบัะฝะฐั ััะพะธะผะพััั ะดะพััะฐะฒะบะธ ะฟะพ ะทะพะฝะฐะผ:"
echo "     - ะััะถะฑะฐ: 100โฝ (ะฑะตัะฟะปะฐัะฝะพ ะพั 800โฝ)"
echo "     - ะฆะตะฝััะฐะปัะฝัะน/ะะฐัะธะฝะพัััะพะธัะตะปั/ะะะ/ะกะตะฒะตัะฝัะน/ะะพัะณะฐะท: 200โฝ (ะฑะตัะฟะปะฐัะฝะพ ะพั 1000โฝ)"
echo "     - ะะฐัั: 250โฝ (ะฑะตัะฟะปะฐัะฝะพ ะพั 1200โฝ)"
echo "     - ะัะพะผัะทะตะป/ะัะธะฑัะตะถะฝัะน: 300โฝ (ะฑะตัะฟะปะฐัะฝะพ ะพั 1500โฝ)"
echo ""
echo "โ๏ธ  ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ:"
echo "   โข HTTP 400 ะดะปั ะฝะตะบะพััะตะบัะฝัั ะดะฐะฝะฝัั"
echo "   โข HTTP 404 ะดะปั ะฐะดัะตัะพะฒ ะฒะฝะต ะทะพะฝั ะดะพััะฐะฒะบะธ"
echo "   โข Fallback ะฝะฐ ััะฐะฝะดะฐััะฝัั ะทะพะฝั ะฟัะธ ะฝะตะพะฟัะตะดะตะปะตะฝะฝะพััะธ"
echo ""
echo "๐ ะขะตััะธัะพะฒะฐะฝะธะต ะทะฐะฒะตััะตะฝะพ: $(date '+%Y-%m-%d %H:%M:%S')" 